<?php
namespace App\Http\Controllers;

/*
 * Ce fichier fait partie du projet Home Server Maison
 * Copyright (C) 2024 Floris Robart <florobart.github@gmail.com>
 */

use App\Mail\AddIpMail;
use App\Models\AdresseIP;
use Illuminate\Http\Request;
use App\Models\User;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Mail;

class ProfilController extends Controller
{
    /*-------------*/
    /* Inscription */
    /*-------------*/
    /**
     * Affiche le formulaire d'inscription
     */
    public function inscription()
    {
        return view('profil.inscription');
    }


    /**
     * Enregistre les informations de l'inscription
     */
    public function inscriptionSave(Request $request)
    {
        /* Validation des informations du formulaire */
        $request->validate([
            'name' => 'required|min:3|max:18',
            'email' => 'required|email|unique:users,email',
            'password' => 'required|min:4|max:20',
            'password_confirmation' => 'required|same:password',
            'profil_image' => 'required|image|mimes:jpeg,png,jpg',
        ], [
            'name.required' => 'Le nom est obligatoire',
            'name.min' => 'Le nom doit contenir au moins 3 caract√®res',
            'name.max' => 'Le nom ne peux pas contenir plus de 18 caract√®res',
            'email.required' => 'L\'adresse mail est obligatoire',
            'email.email' => 'L\'adresse mail n\'est pas valide',
            'email.unique' => 'Vous avez d√©j√† un compte avec cette adresse mail',
            'password.required' => 'Le mot de passe est obligatoire',
            'password.min' => 'Le mot de passe doit contenir au moins 4 caract√®res',
            'password.max' => 'Le mot de passe ne peux pas contenir plus de 20 caract√®res',
            'password_confirmation.required' => 'La confirmation du mot de passe est obligatoire',
            'password_confirmation.same' => 'Les mots de passe doivent √™tre identiques',
            'profil_image.required' => 'L\'image de profil est obligatoire',
            'profil_image.image' => 'Votre image de profil doit √™tre une image',
            'profil_image.mimes' => 'Votre image de profil doit √™tre au format jpeg, jpg ou png',
        ]);

        /* R√©cup√©ration des informations du formulaire */
        $name = $request->name;
        $email = $request->email;
        $password = Hash::make($request->password);
        $imgProfil = base64_encode(file_get_contents($request->profil_image));

        /* Enregistrement des informations dans la base de donn√©es */
        User::create([
            'name' => $name,
            'email' => $email,
            'password' => $password,
            'imgProfil' => $imgProfil,
            'last_login_at' => now(),
        ]);

        /* Enregistrement de l'adresse IP de l'utilisateur */
        $adresseIP = request()->ip();
        DB::table('adresse_ips')->insert([
            'user_id' => User::where('email', $email)->first()->id,
            'adresse_ip' => $adresseIP,
            'est_bannie' => false,
        ]);

        /* Connexion de l'utilisateur */
        if (Auth::attempt($request->only('email', 'password'))) {
            return redirect()->route('private.accueil')->with('success', 'Inscription r√©ussie üëç');
        } else {
            return back()->with(['error' => 'Erreur lors de l\'inscription r√©essayez plus tard ou envoyez un mail √† l\'administrateur √† l\'adresse suivante : ', 'name' => $name, 'email' => $email]); // TODO : Ajouter l'adresse mail de l'administrateur
        }
    }



    /*-----------*/
    /* Connexion */
    /*-----------*/
    /**
     * Connecte l'utilisateur si les informations sont correctes
     */
    public function connexionSave(Request $request)
    {
        /* Validation des informations du formulaire */
        $request->validate([
            'email' => 'required|email|exists:users,email',
            'password' => 'required|min:4|max:20',
        ], [
            'email.required' => 'L\'adresse mail est obligatoire',
            'email.email' => 'L\'adresse mail n\'est pas valide',
            'email.exists' => 'Aucun compte n\'est associ√© √† cette adresse mail',
            'password.required' => 'Le mot de passe est obligatoire',
            'password.min' => 'Le mot de passe doit contenir au moins 4 caract√®res',
            'password.max' => 'Le mot de passe ne peux pas contenir plus de 20 caract√®res',
        ]);

        /* R√©cup√©ration des informations du formulaire */
        $email = $request->email;
        $password = $request->password;

        /* V√©rification des informations de connexion */
        $user = User::where('email', $email)->first();
        if (!$user || !Hash::check($password, $user->password)) {
            return back()->with(['error' => 'Mot de passe incorrect', 'email' => $email]);
        }

        /* V√©rification de l'adresse IP */
        $message = [
            '0' => 'C\'est la premi√®re fois que vous vous connectez depuis cet endroit, veuillez certifier qu\'il s\'agit bien de vous en cliquant sur le lien envoy√© par mail √† l\'adresse suivante : ' . $email,
            '2' => 'Un email vous a d√©j√† √©t√© envoy√© √† l\'adresse ' . $email . ' pour v√©rifier qu\'il s\'agit bien de vous, veuillez v√©rifier votre boite mail',
            '3' => 'Vous √™tes bannie ! Cet √©v√®nement serait rapporter √† l\'administrateur, en ignorant votre banissement vous vous engagez √† de potentiel poursuite judiciaire !',
        ];

        $ipFound = $this->verifIp($user, request()->ip());
        if ($ipFound != 1) {
            return back()->with(['error' => $message[$ipFound], 'email' => $email]);
        }

        /* Connexion de l'utilisateur */
        if (Auth::check()) { Auth::logout(); }
        Auth::login($user);

        /* Mise √† jour de la date de derni√®re connexion */
        $user->last_login_at = now();
        $user->save();

        /* Redirection vers la page d'accueil */
        return redirect()->route('private.accueil');
    }



    /*------------*/
    /* Adresse IP */
    /*------------*/
    /**
     * V√©rifie l'adresse IP de l'utilisateur. Si l'adresse IP n'est pas autoris√©e, un mail est envoy√© √† l'utilisateur pour l'ajouter √† la liste blanche
     * @param User $user l'utilisateur qui veut se connecter
     * @param string $ip l'adresse IP de l'utilisateur
     * @return int
     * - 0 si l'adresse IP n'est pas autoris√©e
     * - 1 si l'adresse IP est autoris√©e
     * - 2 si un mail a d√©j√† √©t√© envoy√©
     * - 3 si l'adresse IP est bannie
     */
    public function verifIp(User $user, string $ip)
    {
        /* V√©rification si l'adresse IP est bannie */
        $adresseIPBannie = AdresseIP::where('user_id', $user->id)->where('adresse_ip', $ip)->where('est_bannie', true)->first();
        if ($adresseIPBannie) {
            return 3;
        }

        /* V√©rification si l'adresse IP est autoris√©e */
        $authorisedIps = AdresseIP::where('user_id', $user->id)->where('est_bannie', false)->get();
        $ipFound = false;
        foreach ($authorisedIps as $authorisedIp) {
            if ($authorisedIp->adresse_ip == $ip) {
                $ipFound = true;
                break;
            }
        }

        if (!$ipFound)
        {
            /* V√©rification de l'existence d'un token de connexion */
            $tokenDB = DB::table('adresse_ips_tokens')->where('email', $user->email)->where('adresse_ip', $ip)->first();
            if ($tokenDB != null) {
                return 2;
            }

            /* G√©n√©ration d'un token de connexion */
            $token = bin2hex(random_bytes(64));

            /* Enregistrement du token de connexion */
            DB::table('adresse_ips_tokens')->insert([
                'email' => $user->email,
                'adresse_ip' => $ip,
                'token' => $token,
                'created_at' => now(),
            ]);

            /* Envoi du mail de v√©rification */
            $data = [
                'email' => $user->email,
                'token' => $token,
                'ip' => $ip,
            ];

            /* Envoie du mail */
            Mail::to($user->email)->send(new AddIpMail($data));
        }

        return $ipFound ? 1 : 0;
    }

    /**
     * Ajoute une adresse IP √† la liste blanche
     * @param string $token le token de connexion
     * @param string $ip l'adresse IP √† ajouter
     * @return Route accueil | avec un message de succ√®s ou d'erreur
     * @method GET
     */
    public function addIp(string $token, string $ip)
    {
        /*-------------------------------*/
        /* R√©cup√©ration des informations */
        /*-------------------------------*/
        $tokenDB = DB::table('adresse_ips_tokens')->where('token', $token)->first();
        $email = $tokenDB->email;
        $user = User::where('email', $email)->first();
        $adresseIp = request()->ip();


        /*--------------------------------------*/
        /* V√©rification de la validit√© du token */
        /*--------------------------------------*/
        if ($tokenDB == null)
        {
            /* Bannissement de l'adresse IP */
            $this->banIp($email, $adresseIp);

            return redirect()->route('accueil')->with('error', 'Vous avez √©t√© bannie !');
        }


        /*---------------------------------------------*/
        /* V√©rification de la validit√© de l'adresse IP */
        /*---------------------------------------------*/
        if ($ip != $adresseIp || $ip != $tokenDB->adresse_ip || $adresseIp != $tokenDB->adresse_ip)
        {
            /* Bannissement de l'adresse IP */
            $this->banIp($email, $adresseIp);

            return redirect()->route('accueil')->with('error', 'Vous avez changer d\'endroit entre le moment o√π vous avez demander √† v√©rifier votre email et le moment ou vous avez cliqu√© sur le lien dans le mail, par mesure de s√©curit√© vous avez √©t√© bannie. Si c\'est bien vous qui avez demander √† v√©rifier votre email, veuillez contacter l\'administrateur');
        }
        else
        {
            $adresseIPBannie = AdresseIP::where('user_id', $user->id)->where('adresse_ip', $ip)->where('est_bannie', true)->first();
            if ($adresseIPBannie)
            {
                return redirect()->route('accueil')->with(['error' => 'Vous √™tes bannie ! Cet √©v√®nement serait rapporter √† l\'administrateur, en ignorant votre banissement vous vous engagez √† de potentiel poursuite judiciaire !', 'email' => $email]);
            }
        }


        /*----------------------------------*/
        /* Ajout de l'adresse IP √† la liste */
        /*----------------------------------*/
        $builder = DB::table('adresse_ips')->insert([
            'user_id' => $user->id,
            'adresse_ip' => $ip,
            'est_bannie' => false,
        ]);

        if ($builder != null)
        {
            /* Suppression du token */
            DB::table('adresse_ips_tokens')->where('token', $token)->delete();

            return redirect()->route('accueil')->with('success', 'Vous pouvez maintenant vous connecter depuis cette endroit üëç');
        }

        return redirect()->route('accueil')->with('error', 'Une erreur est survenue, si le probl√®me persiste veuillez contacter l\'administrateur');
    }

    /**
     * Bannit l'adresse IP
     * @param string $email
     * @param string $ip √† bannir
     * @return bool true si l'adresse IP est bannie sinon false
     */
    private function banIp(string $email, string $ip)
    {
        /* R√©cup√©ration de l'utilisateur */
        $user = User::where('email', $email)->first();
        if ($user == null) { return false; }

        /* V√©rification si l'adresse IP est d√©j√† bannie */
        $adresseIp = AdresseIP::where('user_id', $user->id)->where('adresse_ip', $ip)->first();
        if ($adresseIp != null)
        {
            $adresseIp->est_bannie = true;
            $adresseIp->save();

            return true;
        }

        /* Bannissement de l'adresse IP */
        $builder = DB::table('adresse_ips')->insert([
            'user_id' => $user->id,
            'adresse_ip' => $ip,
            'est_bannie' => true,
        ]);

        if ($builder != null)
        {
            /* Suppression du token */
            DB::table('adresse_ips_tokens')->where('email', $email)->where('adresse_ip', $ip)->delete();
        }

        return $builder != null;
    }



    /*--------*/
    /* Profil */
    /*--------*/
    /**
     * Affiche la page du profil
     */
    public function profil()
    {
        if (auth()->check()) {
            return view('profil.profil');
        } else {
            return redirect()->route('accueil');
        }
    }


    /**
     * Enregistre les informations du profil
     */
    public function profilSave(Request $request)
    {
        /* R√©cup√©ration des informations du formulaire */
        $request->validate([
            'name' => 'required|min:3|max:18',
            'email' => 'required|email|unique:users,email,' . Auth::user()->id,
            'password' => 'nullable|min:4|max:20',
            'profil_image' => 'nullable|image|mimes:jpeg,png,jpg',
        ], [
            'name.required' => 'Le nom est obligatoire',
            'name.min' => 'Le nom doit contenir au moins 3 caract√®res',
            'name.max' => 'Le nom ne peux pas contenir plus de 18 caract√®res',
            'email.required' => 'L\'adresse mail est obligatoire',
            'email.email' => 'L\'adresse mail n\'est pas valide',
            'email.unique' => 'Vous ne pouvez pas utiliser cette adresse mail',
            'password.min' => 'Le mot de passe doit contenir au moins 4 caract√®res',
            'password.max' => 'Le mot de passe ne peux pas contenir plus de 20 caract√®res',
            'profil_image.image' => 'Votre image de profil doit √™tre une image',
            'profil_image.mimes' => 'Votre image de profil doit √™tre au format jpeg, jpg ou png',
        ]);

        /* V√©rification des informations du formulaire */
        $name = $request->name;
        $email = $request->email;

        $modif = false;
        /* Enregistrement des informations dans la base de donn√©es */
        if (auth()->user()->name != $name || auth()->user()->email != $email || $request->password != null)
        {
            $user = User::find(Auth::user()->id);

            if ($user->name != $name) { $user->name = $name; }
            if ($user->email != $email) { $user->email = $email; }
            if ($request->password != null) { $user->password = Hash::make($request->password); }

            $user->save();
            $modif = true;
        }

        /* Enregistrement de l'image de profil */
        if ($request->profil_image != null)
        {
            $user = User::find(Auth::user()->id);
            $user->imgProfil = base64_encode(file_get_contents($request->profil_image));
            $user->save();
            $modif = true;
        }

        if ($modif)
        {
            /* Redirection vers la page du profil */
            return back()->with('success', 'Votre profil √† bien √©t√© mis √† jour üëç');
        }

        /* Redirection vers la page du profil */
        return back()->with('success', 'Vous avez fait aucune modification üëç');
    }



    /*-------------*/
    /* D√©connexion */
    /*-------------*/
    /**
     * D√©connecte l'utilisateur et le redirige vers la page d'accueil
     */
    public function deconnexion()
    {
        /* D√©connexion de l'utilisateur */
        if (Auth::check())
        {
            Auth::logout();
        }

        /* Redirection vers la page d'accueil */
        return Redirect()->route('accueil');
    }



    /*-----------------------*/
    /* Suppression de compte */
    /*-----------------------*/
    /**
     * D√©connecte l'utilisateur
     * Puis supprime le compte de l'utilisateur
     * Puis le redirige vers la page d'accueil
     */
    public function supprimerCompte()
    {
        /* V√©rification de la connexion de l'utilisateur */
        if (!Auth::check()) {
            return Redirect('accueil');
        }

        /* R√©cup√©ration des informations de l'utilisateur */
        $user = User::find(Auth::user()->id);

        /* D√©connexion de l'utilisateur */
        Auth::logout();

        /* Suppression des sessions de l'utilisateur */
        DB::table('sessions')->where('user_id', $user->id)->delete();

        /* Suppression du compte de l'utilisateur */
        User::destroy($user->id);

        /* Redirection vers la page d'accueil */
        return Redirect('accueil');
    }
}
